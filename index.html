<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zona Sul - AI Platform - Loja 100</title>
    <style>
        /* Professional and Compact Styling */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; color: #333; font-size: 13px; }
        .header { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .header-brand h1 { font-size: 1.4rem; font-weight: 700; }
        .header-brand .subtitle { font-size: 0.8rem; opacity: 0.9; margin-top: 0.1rem; }
        .container { max-width: 1800px; margin: 0 auto; padding: 1rem; }
        .nav-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .nav-tab { background: #f8f9fa; border: 1px solid #e5e7eb; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 500; color: #374151; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 0.4rem; font-size: 0.85rem; }
        .nav-tab.active { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; border-color: #dc2626; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .grid { display: grid; gap: 0.75rem; }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .card { background: white; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.07); border: 1px solid #f3f4f6; transition: all 0.2s; }
        .card.clickable:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }
        .card-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.25rem; }
        .card-subtitle { font-size: 0.75rem; color: #6b7280; }
        .metric-large { font-size: 1.8rem; font-weight: 700; }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; border-bottom: 2px solid #dc2626; padding-bottom: 0.4rem; color: #333; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th, td { padding: 0.4rem 0.6rem; text-align: left; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        th { background: #f8f9fa; font-weight: 600; }
        td .clickable { cursor: pointer; text-decoration: underline; color: #1e40af; font-weight: 500; }
        .badge { padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.7rem; font-weight: 500; display: inline-block; margin: 1px; }
        .badge-danger { background: #fecaca; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-event { background-color: #e5e7eb; color: #374151; }
        .chef-selection-container { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; }
        .selection-column .card { padding: 0.75rem; }
        .selection-column .card-title { font-size: 0.85rem; }
        .selection-column .card-subtitle { font-size: 0.7rem; }
        .selection-column.disabled { opacity: 0.5; pointer-events: none; }
        .selectable-card.selected { border-color: #dc2626; box-shadow: 0 0 0 2px #dc2626; }
        .recipe-results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .recipe-item { display: flex; align-items: center; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
        .recipe-item input[type="checkbox"] { margin-right: 0.75rem; }
        .recipe-item-info { flex-grow: 1; cursor: pointer; }
        .recipe-item-info h4 { font-size: 0.85rem; font-weight: 600; }
        .recipe-item-info p { font-size: 0.75rem; color: #6b7280; }
        .factors-container { display: flex; gap: 1rem; align-items: stretch; margin-bottom: 1rem; }
        .factors-container .card { flex: 1; }
        .event-list { list-style: none; padding: 0; font-size: 0.75rem; }
        .event-list li { margin-bottom: 0.4rem; }
        .weather-grid { display: grid; grid-template-columns: repeat(5, 1fr); text-align: center; }
        .weather-grid .day { font-weight: 600; font-size: 0.75rem; }
        .weather-grid .weather-icon { font-size: 1.5rem; }
        .weather-grid .temp { font-size: 0.8rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-content { background: white; border-radius: 1rem; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); position: relative; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; background: #e5e7eb; border: none; border-radius: 50%; width: 2.5rem; height: 2.5rem; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .modal-body { padding: 1.5rem 2rem; }
        .modal-actions { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500; transition: all 0.2s; font-size: 0.85rem; }
        .btn-primary { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; }
        .btn-strategy { background-color: #e5e7eb; color: #374151; font-size: 0.75rem; padding: 0.3rem 0.6rem; margin: 0.1rem; }
        .trend { font-size: 0.9rem; font-weight: 600; margin-left: 0.5rem; }
        .trend-up { color: #10b981; }
        .trend-down { color: #dc2626; }
    </style>
</head>
<body>
    <div class="header">
        <div><h1>SUPERMERCADO ZONA SUL</h1><div class="subtitle">Plataforma IA de Redu√ß√£o de Desperd√≠cio</div></div>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab(event, 'manager-view')">üìä Painel do Gerente</button>
            <button class="nav-tab" onclick="showTab(event, 'inventory')">üì¶ Estoque</button>
            <button class="nav-tab" onclick="showTab(event, 'customers')">üë• Clientes</button>
            <button class="nav-tab" onclick="showTab(event, 'forecast')">üìà Previs√£o</button>
            <button class="nav-tab" onclick="showTab(event, 'chef-lidy')">üë®‚Äçüç≥ Chef IA</button>
            <button class="nav-tab" onclick="showTab(event, 'insights')">üí° Insights</button>
        </div>

        <div id="manager-view" class="tab-content active">
             <div class="grid grid-cols-2" style="gap: 1rem;">
                <div>
                    <h2 class="section-title">Resumo do Estoque</h2>
                    <div class="grid grid-cols-2">
                        <div class="card clickable" onclick="showTab(null, 'inventory', true)"><div class="card-title">SKUs Perec√≠veis</div><div class="metric-large">100</div></div>
                        <div class="card clickable" onclick="showTab(null, 'inventory', true)"><div class="card-title">Itens em Risco</div><div id="manager-at-risk-item-count" class="metric-large" style="color: #f59e0b;"></div></div>
                        <div class="card clickable" onclick="showTab(null, 'inventory', true)"><div class="card-title">Valor em Estoque</div><div id="manager-total-stock-value" class="metric-large"></div></div>
                        <div class="card clickable" onclick="showTab(null, 'inventory', true)"><div class="card-title">Valor em Risco</div><div id="manager-at-risk-value" class="metric-large" style="color: #dc2626;"></div></div>
                    </div>
                </div>
                <div>
                    <h2 class="section-title">Resumo de Clientes</h2>
                    <div class="grid grid-cols-2">
                        <div id="kpi-total-clients" class="card clickable" onclick="showTab(null, 'customers', true)"></div>
                        <div id="kpi-avg-basket" class="card clickable" onclick="showTab(null, 'customers', true)"></div>
                        <div id="kpi-visit-freq" class="card clickable" onclick="showTab(null, 'customers', true)"></div>
                        <div id="kpi-ytd-revenue" class="card clickable" onclick="showTab(null, 'customers', true)"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="inventory" class="tab-content">
            <h2 class="section-title">Itens em Risco de Estoque</h2>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th style="text-align: center;">SKU</th>
                            <th style="text-align: center;">Estoque</th>
                            <th style="text-align: center;">Valor em Risco</th>
                            <th style="text-align: center;">Expira em</th>
                            <th style="text-align: center;">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="at-risk-item-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="customers" class="tab-content">
             <div class="grid grid-cols-3" id="customer-segment-list"></div>
        </div>

        <div id="forecast" class="tab-content">
            <h2 class="section-title">Fatores Externos (prox 7 dias)</h2>
            <div class="factors-container">
                <div class="card">
                    <div class="card-title">üìÖ Eventos</div>
                    <ul id="events-list" class="event-list"></ul>
                </div>
                <div class="card">
                    <div class="card-title">‚öΩ Jogos</div>
                    <ul id="matches-list" class="event-list"></ul>
                </div>
                <div class="card">
                    <div class="card-title">üå¶Ô∏è Tempo</div>
                    <div id="weather-forecast" class="weather-grid"></div>
                </div>
            </div>
            <h2 class="section-title">Previs√£o de Demanda</h2>
            <div class="card">
                 <table>
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th style="text-align: center;">Estoque</th>
                            <th style="text-align: center;">Demanda Prevista</th>
                            <th>Fatores de Influ√™ncia</th>
                            <th style="text-align: center;">Status</th>
                            <th>Recomenda√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="forecast-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <div id="chef-lidy" class="tab-content">
            <div class="card">
                <div class="chef-selection-container">
                    <div id="segment-selection-column" class="selection-column">
                        <h3 class="section-title">Passo 1: Selecione o Segmento</h3>
                        <div id="chef-ia-segments" class="grid grid-cols-2"></div>
                    </div>
                    <div id="chef-selection-column" class="selection-column disabled">
                        <h3 class="section-title">Passo 2: Escolha o Chef</h3>
                        <div id="chef-ia-chef-list" class="grid grid-cols-1"></div>
                    </div>
                </div>
                
                <div id="chef-ia-results-container" style="display:none; margin-top: 1.5rem;">
                    <h3 class="section-title">Passo 3: Selecione as Receitas</h3>
                    <div id="chef-ia-recipes-container" class="recipe-results-grid"></div>
                    <div id="chef-ia-campaign-buttons" style="margin-top: 1rem; text-align:center;">
                        <button class="btn btn-primary" onclick="createEmailCampaignFromSelected()">Criar Campanha</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="insights" class="tab-content">
             <div class="card">
                <div class="card-title">Painel de Impacto da Plataforma - Loja 100</div>
                 <div class="grid grid-cols-4" style="margin-top: 1.5rem; text-align: center;">
                    <div class="card clickable" onclick="handleInsightClick('overstock')"><div class="card-subtitle">Valor de Super√°vit Gerenciado (M√™s)</div><div id="insights-overstock-value" class="metric-large"></div></div>
                    <div class="card clickable" onclick="handleInsightClick('recipe')"><div class="card-subtitle">Impacto das Receitas Promovidas</div><div id="insights-recipe-impact" class="metric-large" style="color: #10b981;"></div></div>
                    <div class="card clickable" onclick="handleInsightClick('losses')"><div class="card-subtitle">Perdas Totais Reduzidas</div><div id="insights-losses-reduced" class="metric-large" style="color: #3b82f6;"></div></div>
                    <div class="card clickable" onclick="handleInsightClick('projection')"><div class="card-subtitle">Proje√ß√£o Anual de Redu√ß√£o de Perdas</div><div id="insights-annual-projection" class="metric-large" style="color: #dc2626;"></div></div>
                </div>
             </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <button class="modal-close">&times;</button>
            <div class="modal-body">
                <h2 id="confirmation-title" style="margin-bottom: 1rem;"></h2>
                <p id="confirmation-message" style="font-size: 1rem; line-height: 1.5;"></p>
                <button id="confirmation-close" class="btn btn-primary" style="margin-top: 2rem;">Fechar</button>
            </div>
        </div>
    </div>
    <div id="action-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <button class="modal-close">&times;</button>
            <div class="modal-body">
                <h3 id="action-modal-title" style="margin-bottom: 1rem;"></h3>
                <div id="action-modal-buttons" class="modal-actions"></div>
            </div>
        </div>
    </div>


    <script>
        // --- DATA STRUCTURES (GLOBAL) ---
        const masterProductList = [];
        const categories = ['Frutas', 'Vegetais', 'Carnes', 'Peixes', 'Latic√≠nios', 'Bebidas'];
        const names = {
            'Frutas': ['Morango', 'Uva Thompson', 'Manga Palmer', 'Abacate', 'Kiwi', 'Banana Prata', 'Ma√ß√£ Fuji', 'Mam√£o Formosa', 'Laranja Pera', 'P√™ssego'],
            'Vegetais': ['R√∫cula', 'Tomate Italiano', 'Br√≥colis', 'Cenoura', 'Abobrinha', 'Alface Crespa', 'Piment√£o Amarelo', 'Cebola Roxa', 'Batata Doce', 'Espinafre'],
            'Carnes': ['Patinho Mo√≠do', 'Fil√© de Frango', 'Bife de Chorizo', 'Lingui√ßa Toscana', 'Costela Su√≠na', 'Picanha', 'Alcatra', 'Fraldinha', 'Cora√ß√£o de Galinha', 'Bacon'],
            'Peixes': ['Salm√£o', 'Til√°pia', 'Camar√£o', 'Lula', 'Polvo', 'Sardinha', 'Robalo', 'Mexilh√£o', 'Bacalhau', 'Atum Fresco'],
            'Latic√≠nios': ['Queijo Brie', 'Iogurte Grego', 'Leite Integral', 'Requeij√£o', 'Manteiga', 'Queijo Minas', 'Parmes√£o', 'Cream Cheese', 'Nata', 'Mussarela de B√∫fala'],
            'Bebidas': ['Cerveja', 'Refrigerante', 'Vinho Tinto', '√Ågua de Coco', 'Suco de Laranja', 'Vinho Branco', 'Guaran√°', 'Energ√©tico', 'Ch√° Gelado', '√Ågua com G√°s']
        };

        for (let i = 0; i < 100; i++) {
            const category = categories[Math.floor(i / 16.6)];
            masterProductList.push({
                id: i + 1, name: names[category][i % 10] || `${category} Item ${i}`, category: category,
                price: parseFloat((Math.random() * 80 + 5).toFixed(2)), stock: Math.floor(Math.random() * 150 + 20),
                expiresInDays: Math.floor(Math.random() * 15 + 1), forecastedDemand: Math.floor(Math.random() * 150 + 20)
            });
        }
        
        const atRiskProducts = masterProductList.filter(p => p.expiresInDays <= 4).sort((a,b) => a.expiresInDays - b.expiresInDays);

        const managerKPIs = {
            totalClients: { current: 1258, previous: 1230, period: "vs Semana Anterior" },
            avgBasket: { current: 166.50, previous: 162.00, period: "vs M√™s Anterior" },
            visitFreq: { current: 2.1, previous: 2.3, period: "vs M√™s Anterior" },
            ytdRevenue: { current: 1_250_480, previous: 1_180_950, period: "vs Ano Anterior" }
        };

        const customerSegments = [
            { id: 1, name: 'Foco em Vida Saud√°vel', clients: 1842, status: 'Saud√°vel', tendency: 'up', details: { basket: 156.80, freq: 2.3}, strategic_suggestions: [{text:'Receitas Fit', action:'recipe'}, {text:'Promover Org√¢nicos', action:'promotion'}, {text:'Evento de Nutri√ß√£o', action:'event'}], recommendedChef: 3 },
            { id: 2, name: 'Fam√≠lias Cariocas', clients: 2156, status: 'Em Aten√ß√£o', tendency: 'down', details: { basket: 234.50, freq: 1.2}, strategic_suggestions: [{text:'Kit Fam√≠lia', action:'price'}, {text:'Desconto Progressivo', action:'price'}, {text:'Receitas Pr√°ticas', action:'recipe'}], recommendedChef: 2 },
            { id: 4, name: 'Entusiastas Gourmet', clients: 987, status: 'Saud√°vel', tendency: 'up', details: { basket: 198.00, freq: 1.8}, strategic_suggestions: [{text:'Degusta√ß√£o de Vinhos', action:'event'}, {text:'Promover Importados', action:'promotion'}, {text:'Receitas do Chef', action:'recipe'}], recommendedChef: 1 },
            { id: 5, name: 'Consumidores Eco-Conscientes', clients: 1456, status: 'Saud√°vel', tendency: 'up', details: { basket: 130.40, freq: 1.9}, strategic_suggestions: [{text:'Promover Locais', action:'promotion'}, {text:'Dicas de Reciclagem', action:'event'}], recommendedChef: 3 },
            { id: 6, name: 'Conscientes de Pre√ßo', clients: 1925, status: 'Em Risco', tendency: 'down', details: { basket: 95.70, freq: 1.1}, strategic_suggestions: [{text:'Cupons de Desconto', action:'price'}, {text:'Leve 3 Pague 2', action:'promotion'}] }
        ];

        const contextualFactors = {
            holidays: [ { name: 'Dia do Comerci√°rio', date: '2025-10-17' } ],
            otherEvents: [ { name: 'Rock in Rio - Fim de Semana 1', date: '2025-09-12' } ],
            matches: [
                { home_team: 'Flamengo', away_team: 'Corinthians', date: '2025-08-16', location: 'Maracan√£ (Casa)' },
                { home_team: 'Fluminense', away_team: 'Palmeiras', date: '2025-08-17', location: 'Maracan√£ (Casa)' },
                { home_team: 'Botafogo', away_team: 'Gr√™mio', date: '2025-08-20', location: 'Nilton Santos (Casa)' }
            ],
            weather: [
                { day: 'Sex', temp: '28¬∞C', condition: '‚òÄÔ∏è' }, { day: 'S√°b', temp: '29¬∞C', condition: '‚òÄÔ∏è' },
                { day: 'Dom', temp: '25¬∞C', condition: 'üå¶Ô∏è' }, { day: 'Seg', temp: '24¬∞C', condition: 'üåßÔ∏è' },
                { day: 'Ter', temp: '26¬∞C', condition: '‚òÅÔ∏è' }
            ]
        };

        masterProductList.forEach(p => {
            p.factors = [];
            if (['Picanha', 'Lingui√ßa Toscana', 'Cerveja'].includes(p.name)) p.factors.push('‚öΩ Jogo do Flamengo');
            if (['Salm√£o', 'Queijo Brie', 'Vinho Tinto'].includes(p.name)) p.factors.push('üìÖ Feriado');
            if (['Cerveja', 'Refrigerante', 'Picanha'].includes(p.name) && p.stock > 100) p.factors.push('‚òÄÔ∏è Fim de Semana Ensolarado');
        });

        const chefs = [
            { id: 1, name: 'Chef Lidy', specialty: 'Gastronomia Francesa' },
            { id: 2, name: 'Chef Jimmy', specialty: 'Carnes e Grelhados' },
            { id: 3, name: 'Chef Lorena', specialty: 'Culin√°ria Saud√°vel' },
        ];
        
        const fullRecipeBook = {
            1: [ { name: 'Crepioca Recheada com {product}', time: '15 min', difficulty: 'F√°cil', category: ['Carnes', 'Latic√≠nios'] }, { name: 'Salada de Pote com {product}', time: '20 min', difficulty: 'F√°cil', category: ['Vegetais', 'Frutas'] }, { name: 'Sopa Detox de {product}', time: '40 min', difficulty: 'F√°cil', category: ['Vegetais'] }, { name: 'Omelete de Forno com {product}', time: '25 min', difficulty: 'F√°cil', category: ['Carnes', 'Latic√≠nios', 'Vegetais'] } ],
            2: [ { name: 'Strogonoff Brasileiro de {product}', time: '30 min', difficulty: 'F√°cil', category: ['Carnes'] }, { name: 'Escondidinho de {product}', time: '50 min', difficulty: 'M√©dio', category: ['Carnes'] }, { name: 'Moqueca de {product}', time: '40 min', difficulty: 'M√©dio', category: ['Peixes'] }, { name: 'Torta Salgada de {product}', time: '45 min', difficulty: 'F√°cil', category: ['Carnes', 'Latic√≠nios'] } ],
            4: [ { name: 'Bob√≥ de {product}', time: '45 min', difficulty: 'M√©dio', category: ['Peixes'] }, { name: 'Iscas de {product} com Farofa de Banana', time: '35 min', difficulty: 'M√©dio', category: ['Carnes'] }, { name: 'Risoto de {product}', time: '40 min', difficulty: 'Dif√≠cil', category: ['Peixes', 'Carnes'] }, { name: '{product} na Crosta de Ervas', time: '30 min', difficulty: 'M√©dio', category: ['Carnes', 'Peixes'] }, { name: 'Ceviche de {product} com Manga', time: '20 min', difficulty: 'F√°cil', category: ['Peixes', 'Frutas'] } ],
            5: [ { name: 'Salada de {product} da Horta', time: '15 min', difficulty: 'F√°cil', category: ['Vegetais', 'Frutas'] }, { name: 'Pesto com {product}', time: '20 min', difficulty: 'F√°cil', category: ['Vegetais'] }, { name: 'Conserva de {product}', time: '30 min', difficulty: 'M√©dio', category: ['Vegetais'] } ]
        };
        let generatedRecipes = [];

        function generateRecipesForSegmentAndChef(segmentId) {
            generatedRecipes = []; 
            const segment = customerSegments.find(s => s.id === segmentId);
            const recipeTemplates = fullRecipeBook[segment.id] || fullRecipeBook[1];
            const eligibleProducts = atRiskProducts.filter(p => p.category !== 'Bebidas' && p.name !== 'Atum Fresco');
            let usedProducts = new Set();
            for(const template of recipeTemplates){
                if(generatedRecipes.length >= 4) break;
                const product = eligibleProducts.find(p => template.category.includes(p.category) && !usedProducts.has(p.id));
                if(product){
                    usedProducts.add(product.id);
                    generatedRecipes.push({
                        id: `generated_${segmentId}_${product.id}`, name: template.name.replace('{product}', product.name),
                        mainIngredient: product.name, time: template.time, difficulty: template.difficulty
                    });
                }
            }
            return generatedRecipes;
        }

        // --- RENDER FUNCTIONS ---
        function renderManagerViewTab() {
            const atRiskValue = atRiskProducts.reduce((sum, p) => sum + (p.stock * p.price), 0);
            const totalValue = masterProductList.reduce((sum, p) => sum + (p.stock * p.price), 0);
            document.getElementById('manager-at-risk-item-count').textContent = atRiskProducts.length;
            document.getElementById('manager-at-risk-value').textContent = `R$ ${atRiskValue.toLocaleString('pt-BR', {maximumFractionDigits:0})}`;
            document.getElementById('manager-total-stock-value').textContent = `R$ ${totalValue.toLocaleString('pt-BR', {maximumFractionDigits:0})}`;
            const formatTrend = (current, previous) => {
                const change = ((current - previous) / previous) * 100;
                return `<span class="trend ${change >= 0 ? 'trend-up' : 'trend-down'}">${change >= 0 ? '‚ñ≤' : '‚ñº'} ${change.toFixed(1)}%</span>`;
            };
            document.getElementById('kpi-total-clients').innerHTML = `<div class="card-title">Clientes Ativos (WTD)</div><div class="metric-large">${managerKPIs.totalClients.current.toLocaleString('pt-BR')} ${formatTrend(managerKPIs.totalClients.current, managerKPIs.totalClients.previous)}</div><div class="card-subtitle">${managerKPIs.totalClients.period}</div>`;
            document.getElementById('kpi-avg-basket').innerHTML = `<div class="card-title">Cesta M√©dia (MTD)</div><div class="metric-large">R$ ${managerKPIs.avgBasket.current.toFixed(2)} ${formatTrend(managerKPIs.avgBasket.current, managerKPIs.avgBasket.previous)}</div><div class="card-subtitle">${managerKPIs.avgBasket.period}</div>`;
            document.getElementById('kpi-visit-freq').innerHTML = `<div class="card-title">Frequ√™ncia de Visita (MTD)</div><div class="metric-large">${managerKPIs.visitFreq.current.toFixed(1)}x ${formatTrend(managerKPIs.visitFreq.current, managerKPIs.visitFreq.previous)}</div><div class="card-subtitle">${managerKPIs.visitFreq.period}</div>`;
            document.getElementById('kpi-ytd-revenue').innerHTML = `<div class="card-title">Receita (YTD)</div><div class="metric-large">R$ ${(managerKPIs.ytdRevenue.current/1000000).toFixed(2)}M ${formatTrend(managerKPIs.ytdRevenue.current, managerKPIs.ytdRevenue.previous)}</div><div class="card-subtitle">${managerKPIs.ytdRevenue.period}</div>`;
        }

        function renderInventoryTab() {
            document.getElementById('at-risk-item-table-body').innerHTML = atRiskProducts.map(p => `<tr><td><strong>${p.name}</strong><br><small>${p.category}</small></td><td style="text-align: center;">${p.id.toString().padStart(3, '0')}</td><td style="text-align: center;">${p.stock}</td><td style="text-align: center;">R$ ${(p.price * p.stock).toFixed(2)}</td><td style="text-align: center;"><span class="badge badge-danger">${p.expiresInDays} dias</span></td><td style="text-align: center;"><button class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="handleItemAction(${p.id})">A√ß√£o</button></td></tr>`).join('');
        }
        
        function renderCustomersTab() {
            document.getElementById('customer-segment-list').innerHTML = customerSegments.map(s => {
                const statusBadge = s.status === 'Em Risco' ? 'badge-danger' : s.status === 'Em Aten√ß√£o' ? 'badge-warning' : 'badge-success';
                const trendArrow = s.tendency === 'up' ? '‚ñ≤' : s.tendency === 'down' ? '‚ñº' : '‚ñ¨';
                const trendColor = s.tendency === 'up' ? 'trend-up' : s.tendency === 'down' ? 'trend-down' : '';
                return `<div class="card"><div class="card-header"><span class="card-title">${s.name}</span><span class="badge ${statusBadge}">${s.status}</span></div><p style="font-size: 0.9rem;"><strong>${s.clients.toLocaleString('pt-BR')}</strong> clientes</p><div style="display: flex; justify-content: space-between; margin: 0.75rem 0;"><div><div class="card-subtitle">Cesta M√©dia</div><strong style="font-size: 1.1rem;">R$ ${s.details.basket.toFixed(2)}</strong></div><div><div class="card-subtitle">Frequ√™ncia</div><strong style="font-size: 1.1rem;">${s.details.freq}x/m√™s</strong></div><div><div class="card-subtitle">Tend√™ncia</div><strong style="font-size: 1.1rem;" class="${trendColor}">${trendArrow}</strong></div></div><div><h4 style="font-weight: 600; font-size: 0.8rem; margin-bottom: 0.5rem; text-transform: uppercase;">Sugest√µes Estrat√©gicas</h4><div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">${s.strategic_suggestions.map(sug => `<button class="btn btn-strategy" onclick="handleStrategyClick('${sug.action}', ${s.id})">${sug.text}</button>`).join('')}</div></div></div>`;
            }).join('');
        }

        function renderForecastTab() {
            const formatDate = (dateStr) => new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
            document.getElementById('events-list').innerHTML = [...contextualFactors.holidays, ...contextualFactors.otherEvents].map(e => `<li><strong>${formatDate(e.date)}:</strong> ${e.name}</li>`).join('') || '<li>Nenhum evento.</li>';
            document.getElementById('matches-list').innerHTML = contextualFactors.matches.map(m => `<li><strong>${formatDate(m.date)}:</strong> ${m.home_team} x ${m.away_team} <small>(${m.location})</small></li>`).join('') || '<li>Nenhum jogo.</li>';
            document.getElementById('weather-forecast').innerHTML = contextualFactors.weather.map(w => `<div class="weather-grid-item"><div class="day">${w.day}</div><div class="weather-icon">${w.condition}</div><div class="temp">${w.temp}</div></div>`).join('');
            document.getElementById('forecast-table-body').innerHTML = masterProductList.slice(0, 20).map(p => {
                const diff = p.stock - p.forecastedDemand;
                let status, badgeClass, recomendacao, recomendacaoIcon;
                if (diff > p.stock * 0.2) { status = 'Excesso'; badgeClass = 'badge-info'; recomendacao = 'Promover'; recomendacaoIcon = 'üí°';}
                else if (diff < p.stock * -0.2) { status = 'Cr√≠tico'; badgeClass = 'badge-danger'; recomendacao = 'Comprar'; recomendacaoIcon = 'üõí'; }
                else { status = 'Est√°vel'; badgeClass = 'badge-success'; recomendacao = 'Manter'; recomendacaoIcon = '‚úîÔ∏è'; }
                const factorsHTML = p.factors.map(f => `<span class="badge badge-event">${f}</span>`).join(' ');
                return `<tr><td><strong>${p.name}</strong><br><small>${p.category}</small></td><td style="text-align: center;">${p.stock}</td><td style="text-align: center;">${p.forecastedDemand}</td><td>${factorsHTML || 'N/A'}</td><td style="text-align: center;"><span class="badge ${badgeClass}">${status}</span></td><td class="clickable" onclick="handleForecastAction('${recomendacao}', '${p.name}')">${recomendacaoIcon} ${recomendacao}</td></tr>`;
            }).join('');
        }
        
        function renderChefIATab() {
            document.getElementById('chef-ia-segments').innerHTML = customerSegments.map(s => `<div id="segment-card-${s.id}" class="card selectable-card" onclick="selectCustomerSegment(event, ${s.id})"><div class="card-title">${s.name}</div><p class="card-subtitle">${s.clients.toLocaleString('pt-BR')} clientes</p></div>`).join('');
        }
        
        function renderInsightsTab() {
             const overstockValue = atRiskProducts.reduce((sum, p) => sum + (p.stock * p.price), 0);
             const lossesReduced = overstockValue * 0.20; 
             document.getElementById('insights-overstock-value').textContent = `R$ ${overstockValue.toLocaleString('pt-BR', {maximumFractionDigits:0})}`;
             document.getElementById('insights-recipe-impact').textContent = `R$ ${lossesReduced.toLocaleString('pt-BR', {maximumFractionDigits:0})}`;
             document.getElementById('insights-losses-reduced').textContent = `R$ ${lossesReduced.toLocaleString('pt-BR', {maximumFractionDigits:0})}`;
             document.getElementById('insights-annual-projection').textContent = `R$ ${(lossesReduced * 12).toLocaleString('pt-BR', {maximumFractionDigits:0})}`;
        }

        // --- ACTION HANDLERS & WORKFLOW ---
        function handleStrategyClick(action, segmentId) {
            const segment = customerSegments.find(s => s.id === segmentId);
            switch(action) {
                case 'recipe':
                    showTab(null, 'chef-lidy', true);
                    setTimeout(() => { document.getElementById(`segment-card-${segmentId}`).click(); }, 50);
                    break;
                case 'price':
                    showConfirmationModal("Simula√ß√£o de Otimiza√ß√£o de Pre√ßo",`Para o segmento '${segment.name}', a IA sugere um desconto de 15% na categoria 'Carnes'.`);
                    break;
                case 'promotion':
                    showConfirmationModal("Simula√ß√£o de Campanha",`Criando campanha promocional para o segmento ${segment.name}.`);
                    break;
                case 'event':
                    showConfirmationModal("Simula√ß√£o de Cria√ß√£o de Evento",`Um convite para '${segment.strategic_suggestions.find(s=>s.action==='event').text}' ser√° enviado para os ${segment.clients} clientes.`);
                    break;
            }
        }
        
        function handleItemAction(productId) {
            const product = masterProductList.find(p => p.id === productId);
            document.getElementById('action-modal-title').textContent = `A√ß√µes para: ${product.name}`;
            document.getElementById('action-modal-buttons').innerHTML = `<button class="btn btn-primary" onclick="showTab(null, 'chef-lidy', true); hideActionModal();">üë®‚Äçüç≥ Criar Receita</button><button class="btn" onclick="showConfirmationModal('Desconto Aplicado', 'Desconto de 25% aplicado a ${product.name}.'); hideActionModal();">üí∞ Aplicar Desconto</button>`;
            document.getElementById('action-modal').style.display = 'flex';
        }

        function handleForecastAction(action, productName) {
            if (action === 'Promover') showConfirmationModal("Campanha Promocional Criada",`Nova campanha para ${productName} criada.`);
            else if (action === 'Comprar') showConfirmationModal("Ordem de Compra Simulada",`Pedido de compra para ${productName} enviado.`);
        }

        function handleInsightClick(insightType) {
            const messages = {
                overstock: { title: "Relat√≥rio de Super√°vit", msg: "A maior fonte de super√°vit foi a categoria 'Latic√≠nios'."},
                recipe: { title: "Relat√≥rio de Impacto de Receitas", msg: "A campanha 'Bob√≥ de Camar√£o' (Gourmet) teve a maior convers√£o (12%)."},
                losses: { title: "Relat√≥rio de Redu√ß√£o de Perdas", msg: "A√ß√µes em 'Carnes' e 'Peixes' foram respons√°veis por 70% da redu√ß√£o de perdas."},
                projection: { title: "Detalhes da Proje√ß√£o Anual", msg: "Proje√ß√£o baseada na taxa de redu√ß√£o atual (20%) e expans√£o para 3 novas lojas."}
            };
            showConfirmationModal(messages[insightType].title, messages[insightType].msg);
        }
        
        function selectCustomerSegment(event, segmentId) {
            document.querySelectorAll('#chef-ia-segments .selectable-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            const segment = customerSegments.find(s => s.id === segmentId);
            const recommendedChefId = segment.recommendedChef || 2;
            const chefListEl = document.getElementById('chef-ia-chef-list');
            chefListEl.innerHTML = chefs.map(c => `<div class="card selectable-card ${c.id === recommendedChefId ? 'selected' : ''}" onclick="selectChef(event, ${segmentId}, ${c.id})"><div class="card-title">${c.name}</div><p class="card-subtitle">${c.specialty}</p></div>`).join('');
            document.getElementById('chef-selection-column').classList.remove('disabled');
            selectChef(null, segmentId, recommendedChefId);
        }
        
        function selectChef(event, segmentId, chefId) {
             if(event) {
                document.querySelectorAll('#chef-ia-chef-list .selectable-card').forEach(c => c.classList.remove('selected'));
                event.currentTarget.classList.add('selected');
             }
             const generated = generateRecipesForSegmentAndChef(segmentId);
             renderGeneratedRecipes(generated);
             document.getElementById('chef-ia-results-container').style.display = 'block';
        }

        function renderGeneratedRecipes(recipes) {
            const recipesEl = document.getElementById('chef-ia-recipes-container');
            if (recipes.length > 0) {
                recipesEl.innerHTML = recipes.map(r => `<div class="recipe-item"><input type="checkbox" id="recipe-${r.id}" data-recipe-id="${r.id}"><label for="recipe-${r.id}" class="recipe-item-info"><h4>${r.name}</h4><p>${r.time} ‚Ä¢ ${r.difficulty}</p></label></div>`).join('');
            } else {
                recipesEl.innerHTML = '<p class="card-subtitle">Nenhuma receita compat√≠vel encontrada para os itens em risco atuais.</p>';
            }
        }
        
        function createEmailCampaignFromSelected() {
            const selectedCheckboxes = document.querySelectorAll('#chef-ia-recipes-container input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) { showConfirmationModal('Aten√ß√£o','Por favor, selecione pelo menos uma receita para criar a campanha.'); return; }
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.recipeId);
            showConfirmationModal("Campanha Criada", `Simulando campanha com ${selectedIds.length} receita(s) selecionada(s).`);
        }

        // --- UTILITY FUNCTIONS ---
        function showTab(event, tabName, isProgrammatic = false) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            const tabButton = document.querySelector(`.nav-tab[onclick*="'${tabName}'"]`);
            if(tabButton) tabButton.classList.add('active');
        }

        function hideActionModal() { document.getElementById('action-modal').style.display = 'none'; }
        
        function showConfirmationModal(title, message) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').innerHTML = message;
            modal.style.display = 'flex';
        }
        
        // --- APP INITIALIZATION ---
        function initApp() {
            renderManagerViewTab();
            renderInventoryTab();
            renderForecastTab();
            renderCustomersTab();
            renderChefIATab();
            renderInsightsTab();

            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', (e) => e.currentTarget.closest('.modal-overlay').style.display = 'none');
            });
            document.getElementById('confirmation-close').addEventListener('click', () => {
                 document.getElementById('confirmation-modal').style.display = 'none';
            });
        }
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>